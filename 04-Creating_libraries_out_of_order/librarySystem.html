<script src="../simpletest.js"></script>
<script>

// Prototype implementation
  

// Function signature
  // librarySystem(libraryName[, dependencies, callback])

// Function parameters
  // libraryName
  // dependencies array - optional
  // callback - optional (not optional if dependencies array is present)

// Callback parameters
  // elements of dependencies array

// Return value
  // library object
  
// Function description
  // creates a library (called with three arguments)
   // or
  // returns a library if loaded in libraryStorage (called with one argument)

// Requirements
  // librarySystem should accept dependencies array.
  // library cannot work without listed dependencies loaded in libraryStorage.
  // dependencies(libraries) can be loaded out of order.
  // library cannot be loaded unless dependencies are present.
  
  // librarySystem should accept callback.
  // callback should return library.
  // callback should run only once.

  // librarySystem called with one argument 'libraryName' should return that library.

// Function implementation
(function(root, undefined) {
  'use strict';
  const libraryStorage = {};
  
  function librarySystem(libraryName, dependencies, callback) {
    if (arguments.length > 1) {
      let availableDependencies = [];
      let missingDependencies = [];

      if (!Array.isArray(dependencies)) {
        throw new TypeError(`${dependencies} is not an array.`);
      }

      // this function has closure on arguments for the library in question
      function checkDependencies() {
        if (dependencies.length > 0) {
          availableDependencies.length = 0;
          missingDependencies.length = 0;
          dependencies.forEach(function(dependency) {
            if (dependency in libraryStorage && typeof libraryStorage[dependency] !== 'function') {
              availableDependencies.push(libraryStorage[dependency]);
            }
            else {
              missingDependencies.push(dependency);
            }
          });
        }

        if (dependencies.length === availableDependencies.length) {
          libraryStorage[libraryName] = callback(...availableDependencies);
        }
        else {
          console.log(`%cLibrary is loaded, but currently lacks ${missingDependencies.length} dependencies: ${missingDependencies}.`, 'color: red');
          libraryStorage[libraryName] = checkDependencies;
        }
      }

      checkDependencies();
    } 
    else {
      if (typeof libraryStorage[libraryName] === 'function') {
        libraryStorage[libraryName]();
      }

      if (libraryName in libraryStorage && typeof libraryStorage[libraryName] !== 'function') {
        return libraryStorage[libraryName];
      }
      else if (!(libraryName in libraryStorage)){
        throw new ReferenceError(`${libraryName} is not defined.`);
      }
    }
  }

  root['librarySystem'] = librarySystem;

})(this);

tests({
  '': function() {},
  '': function() {},
  '': function() {},
  '': function() {},
  '': function() {},
  '': function() {},
});

</script>